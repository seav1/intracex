name: Add Server Time

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  extend-server:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium

      - name: Extend server time
        env:
          REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        run: |
          python - <<'PY'
          import os
          import time
          from contextlib import suppress
          from playwright.sync_api import sync_playwright, TimeoutError as PWTimeout


          LOGIN_URL = "https://intracex.de/auth/login"
          SERVER_URL = "https://intracex.de/minecraft"
          CONSENT_SELECTOR = 'button.fc-cta-consent.fc-primary-button'
          LOGIN_SELECTORS = (
              'input#email[type="email"][name="email"]',
              'input#password[type="password"][name="password"]',
              'input.btn.btn-primary.btn-block[type="submit"][value="Anmelden"]',
          )
          BUTTON_SELECTOR = 'button:has-text("Verlängern"), a:has-text("Verlängern"), [role="button"]:has-text("Verlängern")'


          def wait_and_consent(page):
              with suppress(Exception):
                  page.wait_for_selector(CONSENT_SELECTOR, state="visible", timeout=5000)
                  page.click(CONSENT_SELECTOR)
                  time.sleep(1)


          def goto(page, url):
              for attempt in range(2):
                  try:
                      print(f"访问 {url} (第 {attempt + 1} 次)")
                      page.goto(url, wait_until="domcontentloaded", timeout=90000)
                      wait_and_consent(page)
                      return True
                  except PWTimeout:
                      if attempt:
                          print("页面加载超时。")
                          return False
                      print("加载超时，5 秒后重试...")
                      time.sleep(5)
                  except Exception as exc:
                      print(f"页面导航出错: {exc}")
                      return False
              return False


          def is_login(page):
              hits = 0
              for selector in LOGIN_SELECTORS:
                  with suppress(Exception):
                      if page.query_selector(selector):
                          hits += 1
              return hits >= 2


          def parse_cookie(raw):
              out = []
              if not raw:
                  return out
              for part in raw.split('; '):
                  if '=' not in part:
                      continue
                  name, value = part.split('=', 1)
                  out.append({
                      'name': name.strip(),
                      'value': value.strip(),
                      'domain': '.intracex.de',
                      'path': '/',
                      'expires': time.time() + 3600 * 24 * 365,
                      'httpOnly': True,
                      'secure': True,
                      'sameSite': 'Lax',
                  })
              return out


          def dump_cookie(context):
              cookies = [
                  f"{c['name']}={c['value']}"
                  for c in context.cookies()
                  if c.get('domain') and 'intracex.de' in c['domain']
              ]
              if cookies:
                  with open('new_cookie.txt', 'w') as fh:
                      value = '; '.join(cookies)
                      fh.write(value)
                      print(f"已写入新 cookie ({len(value)} 字符)。")


          def login_with_cookie(context, page, raw_cookie):
              cookies = parse_cookie(raw_cookie)
              if not cookies:
                  print("Cookie 为空或解析失败。")
                  return False
              context.add_cookies(cookies)
              if not goto(page, SERVER_URL):
                  print("Cookie 导航失败。")
                  page.screenshot(path="cookie_login_fail_navigation.png")
                  return False
              time.sleep(3)
              if any(tag in page.url for tag in ("login", "auth")) or is_login(page):
                  print("Cookie 已失效。")
                  page.screenshot(path="cookie_invalid_login_page.png")
                  return False
              print("Cookie 登录成功。")
              return True


          def login_with_password(context, page, email, password):
              if not goto(page, LOGIN_URL):
                  print("访问登录页失败。")
                  page.screenshot(path="login_page_load_fail.png")
                  return False
              print("使用邮箱密码登录...")
              page.fill('input[name="email"]', email)
              page.fill('input[name="password"]', password)
              page.click('input[type="submit"][value="Anmelden"]')
              try:
                  page.wait_for_load_state("domcontentloaded", timeout=60000)
                  time.sleep(3)
              except Exception as exc:
                  print(f"等待登录结果失败: {exc}")
                  page.screenshot(path="post_login_error.png")
                  return False
              if any(tag in page.url for tag in ("login", "auth")):
                  print("邮箱密码登录失败。")
                  page.screenshot(path="login_fail.png")
                  return False
              print("邮箱密码登录成功。")
              dump_cookie(context)
              if page.url != SERVER_URL and not goto(page, SERVER_URL):
                  print("导航到服务器页面失败。")
                  return False
              return True


          def extend(page):
              page.wait_for_selector(BUTTON_SELECTOR, timeout=30000)
              button = page.query_selector(BUTTON_SELECTOR)
              if not button:
                  print("未找到 'Verlängern' 按钮。")
                  page.screenshot(path="extend_button_not_found.png")
                  return False
              button_class = button.get_attribute("class") or ""
              print(f"按钮 class: {button_class}")
              if "disabled" in button_class:
                  print("按钮禁用，无需续期。")
                  return True
              button.click()
              print("已点击 'Verlängern' 按钮。")
              time.sleep(5)
              page.screenshot(path="extend_success.png")
              return True


          def main():
              cookie = os.environ.get('REMEMBER_WEB_COOKIE')
              email = os.environ.get('LOGIN_EMAIL')
              password = os.environ.get('LOGIN_PASSWORD')

              if not (cookie or (email and password)):
                  print("错误: 未提供 REMEMBER_WEB_COOKIE 或邮箱密码。")
                  return False

              with sync_playwright() as p:
                  browser = p.chromium.launch(
                      headless=True,
                      args=['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'],
                  )
                  context = browser.new_context(
                      viewport={'width': 1920, 'height': 1080},
                      user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                  )
                  page = context.new_page()
                  page.set_default_timeout(60000)

                  try:
                      used_cookie = False
                      if cookie and login_with_cookie(context, page, cookie):
                          used_cookie = True
                      else:
                          context.clear_cookies()
                          if not (email and password and login_with_password(context, page, email, password)):
                              return False

                      print(f"当前页面 URL: {page.url}")
                      time.sleep(3)
                      page.screenshot(path="step1_page_loaded.png")
                      return extend(page)

                  except Exception as exc:
                      print(f"执行失败: {exc}")
                      with suppress(Exception):
                          page.screenshot(path="general_error.png")
                      return False
                  finally:
                      browser.close()


          if __name__ == "__main__":
              print("开始执行添加服务器时间任务...")
              if main():
                  print("任务执行成功。")
                  raise SystemExit(0)
              print("任务执行失败。")
              raise SystemExit(1)
          PY

      - name: Commit updated cookie
        if: success()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -z "${GH_PAT}" ]; then
            echo "缺少 GH_PAT，跳过 cookie 更新提交。"
            exit 0
          fi

          if [ ! -f new_cookie.txt ]; then
            echo "未生成新的 cookie 文件，跳过提交。"
            exit 0
          fi

          git status --short new_cookie.txt
          if git diff --quiet -- new_cookie.txt 2>/dev/null; then
            echo "cookie 内容未变化，跳过提交。"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add new_cookie.txt
          git commit -m "chore: update remember cookie"
          git push "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}" HEAD:${{ github.ref }}

